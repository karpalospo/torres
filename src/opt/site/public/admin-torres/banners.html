
            
<div data-pagina="banner_sup" class="row h100">

    <div class="left-panel">
        
        <div class="tool-row">
            <select data-select="grupo">
                <option value="superior">Superior</option>
                <option value="inferior">Inferior</option>
                <option value="destacados">Destacados</option>
                <option value="categorias">Categorias</option>
                <option value="busqueda">Búsqueda</option>
                <option value="[ALL]">Todos</option>
            </select>
            <input type="text" data-filter="titulo" placeholder="Filtrar por título..."/>
            <select data-select="estado" >
                <option value="1">Activos</option>
                <option value="0">Inactivos</option>
            </select>
            <select data-filter="search-field" >
                <option value="visibles">Visibles</option>
                <option value="vencidos">Vencidos</option>
                <option value="programados">Programados</option>
            </select>
            <button class="page-button" onclick="command('actualizaBanners', this)">Act. Cache</button>
        </div>

        <div class="layer">
            <div class="header">
                <div style="width:300px">Imagen</div>
                <div style="flex:1">Titulo</div>
            </div>
            <table id="lista1" class="fl-table main-list"><tbody></tbody></table>
        </div>

    </div>

    <div class="right-panel">


        <div id="tab-banners">
        
            <div class="tab-menu">
                <div>Edición</div>
                <div>Posición</div>
            </div>
        
            <div class="tab-container">
                
                <div class="tab-info" style="display:none">

                    <div class="tool-row center">
                        <button class="page-button" data-action="new">Nuevo Banner</button>
                        <button class="page-button" data-action="save">Guardar</button>
                        <button class="page-button" onclick="colapsar(true)">Imagenes</button>
                    </div>

                    <div class="layer">

                        <div class="main-form">

                            <div class="form-row" data-label="ID">
                                <div class="form-input">
                                    <input type="text" data-field="id" style="width: 150px;" readonly />
                                </div>
                            </div>

                            <div class="form-row" data-label="Estado">
                                <div class="form-input">
                                    <select data-field="estado">
                                        <option value="0">Inactivo</option>
                                        <option value="1">Activo</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row" data-label="Grupo">
                                <div class="form-input">
                                    <select data-field="grupo"></select>
                                </div>
                            </div>
   
                            <div class="form-row" data-label="Título">
                                <input type="text" data-field="titulo" />
                            </div>

                            <div class="form-row" data-label="Título Público">
                                <input type="text" data-field="titulopublico" />
                            </div>
                            
                            <div class="form-row" data-label="Imagen Web">
                                <input type="text" data-field="imagen" />
                            </div>

                            <div class="form-row" data-label="Imagen Mobile">
                                <input type="text" data-field="imagen2" />
                            </div>

                            <div class="form-row" data-label="Imagen Popup">
                                <input type="text" data-field="imagen3" />
                            </div>

                            <div class="form-row" data-label="Fecha">
                                <div class="form-input">
                                    <input type="date" data-field="fecha_inicio" placeholder="AAAA-MM-DD" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}" style="width: 150px;" />
                                    &nbsp; - &nbsp;
                                    <input type="date" data-field="fecha_fin" placeholder="AAAA-MM-DD" pattern="[0-9]{4}-[0-9]{2}-[0-9]{2}"  style="width: 150px;" />
                                </div>
                            </div>

                            <div class="form-row" data-label="Data" style="display: block;">
                                <textarea data-field="data"></textarea>
                            </div>


                            <div id="tab-destino">
                    
                                <div class="tab-menu">
                                    <div>Action</div>
                                    <div>Banner</div>
                                    <div>Popup</div>
                                </div>
                            
                                <div class="tab-container">
                                    
                                    <div class="tab-info" style="display:none">
                                        <br>
                                        <div class="form-row" data-label="Codigos">
                                            <div class="form-input">
                                                <div class="simple-tags" data-key="codes"></div>
                                                <br>
                                                <form class="subircomponent" enctype="multipart/form-data" method="POST">
                                                    <input type="hidden" name="MAX_FILE_SIZE" value="4000000" />
                                                    <input name="attachment" type="file" /> 
                                                    <input type="submit" value="Enviar Archivo" />
                                                </form>
                                            </div>
                                        </div>

                                        <div class="form-row" data-label="Frases">
                                            <div class="simple-tags" data-key="keywords"></div>
                                        </div>
                                        
                                        <div class="form-row" data-label="Marcas">
                                            <div class="simple-tags" data-key="brand"></div>
                                        </div>

                                        <div class="form-row" data-label="Link Interno">
                                            <div class="form-input">
                                                <div class="input" data-key="link_self"><input type="text"/></div>
                                            </div>
                                        </div>

                                        <div class="form-row" data-label="Link Externo">
                                            <div class="form-input">
                                                <div class="input" data-key="link"><input type="text"/></div>
                                            </div>
                                        </div>

                                    </div>

                                    <div class="tab-info" style="display:none">
                                        <br>
                                        
                                        <div class="form-row" data-label="Categorias">
                                            <div class="simple-tags" data-key="banner_cat"></div>
                                        </div>

                                        <div class="form-row" data-label="Subcategorias">
                                            <div class="simple-tags" data-key="banner_sub"></div>
                                        </div>

                                        <div class="form-row" data-label="Palabras Clave">
                                            <div class="simple-tags" data-key="banner_keywords"></div>
                                        </div>

                                    </div>


                                    <div class="tab-info" style="display:none">
                                        <br>
                                        <div class="form-row" data-label="Home">
                                            <div class="form-input">
                                                <label class="switch" data-key="home_popup"></label>
                                            </div>
                                        </div>
                                        <div class="form-row" data-label="Categorias">
                                            <div class="form-input">
                                                <label class="switch" data-key="cat_popup"></label>
                                            </div>
                                        </div>
                                        <div class="form-row" data-label="Categorias">
                                            <div class="simple-tags" data-key="popup_cat_id"></div>
                                        </div>

                                        <div class="form-row" data-label="Subcategorias">
                                            <div class="simple-tags" data-key="popup_subcat_id"></div>
                                        </div>

                                        <div class="form-row" data-label="Búsqueda">
                                            <div class="form-input">
                                                <label class="switch" data-key="search_popup"></label>
                                            </div>
                                        </div>

                                        <div class="form-row" data-label="Frases">
                                            <div class="simple-tags" data-key="popup_keywords"></div>
                                        </div>

                                        <div class="form-row" data-label="P. Estrella">
                                            <div class="form-input">
                                                <label class="switch" data-key="star_popup"></label>
                                            </div>
                                        </div>

                                        <div class="form-row" data-label="Place Order">
                                            <div class="form-input">
                                                <label class="switch" data-key="order_popup"></label>
                                            </div>
                                        </div>

                                    </div>



                                </div>
                            </div>

                        </div>

                    </div>

                </div>


                <div class="tab-info" style="display:none">

                    <div class="layer">

                        <div class="main-form">

                            <div class="listas" style="max-width: 500px;">
                                
                                <div id="btn-posiciones" class="row">
                                    <button data-id="superior">Superior</button>
                                    <button data-id="inferior">Inferior</button>
                                    <button data-id="destacados">Destacados</button>
                                    <button data-id="categorias">Categorias</button>
                                    <button data-id="busquedas">Búsqueda</button>
                                </div>
                                <br/>
                                <div class="pos-title" id="lbl-grupo"></div>
                                <div class="row">
                                    <div><button class="page-button" onclick="command('guardarBanners', this)">Guardar</button></div>
                                    <div style="flex:1">
                                        <button class="page-button" onclick="command('visualizarBanners', this)">Previsualizar</button>
                                    </div>
                                </div>
                                
                                <!-- lista dos -->
                                <div class="header">
                                    <div style="width:300px">Imagen</div>
                                    <div style="flex:1">Titulo</div>
                                </div>
                                <table id="lista2" class="fl-table" style="min-height: 100px;">
                                    <tbody></tbody>
                                </table>
    
                            </div>
                        </div>

                    </div>
        
                    <template class="template-list">
                        <tr data-id={{id}} class="{{activo}}" style="display:{{display}}; opacity:{{opacity}}">
                            <td style="width:300px"><img src="{{imagen}}" style="width: auto; max-height: 80px;" alt="" /></td>
                            <td>
                                <b>{{titulo}}</b>
                                <br><span class="fecha2">{{fecha_inicio}} - {{fecha_fin}}</span>
                                <br><span class="status-{{status}}">{{status}}</span>
                            </td>
                        </tr>
                    </template>
        
                  
                </div>
    
            </div>
        
        </div>

    </div>

    <template class="template-list">
        <tr data-id={{id}} class="{{activo}}" style="display:{{display}}; opacity:{{opacity}}">
            <td style="width:300px">
                <img src="{{imagen}}" style="max-height: 80px; background-color: #f2f2f2;" alt="" />
            </td>
            <td>
                <b>{{titulo}}</b>
                <br><span class="fecha2">{{fecha_inicio}} - {{fecha_fin}}</span>
                <br><span class="status-{{status}}">{{status}}</span>
            </td>
        </tr>
    </template>

</div>

<script>


    bnInitTabs($("#tab-banners"), 0, tabChanged);
    bnInitTabs($("#tab-destino"));

    $(".simple-tags").each(function() {
        Tags(this);
    })

    // banner superior
    $parent = $("[data-pagina='banner_sup']")

    setLabels($parent.find(".main-form"))
 
    // grupos
    renderSelect($parent.find("[data-field='grupo']"), {
        "superior":"Superior",
        "inferior":"Inferior",
        "destacados":"Destacados",
        "categorias":"Categorias",
        "busqueda":"Búsqueda",
    })

    // estados
    renderSelect($parent.find("[data-field='position']"), {
        "ninguna":"Ninguna",
        "pedido":"Confirmar Pedido",
        "categoria":"Categoria",
        "busqueda":"Busqueda",
        "home":"Home",
    })
    
    // list form

    //ds_banners


    banner_sup = new LIST_FORM({
        
        ds: new DATASET({
            affect: "banner_sup",
            api_model: "banners2",
            sort: {id: "DESC"},
            scheme: {
                id: null,
                estado: 1, 
                data: null,
                imagen: null,
                imagen2: null,
                imagen3: null,
                position: "ninguna",
                titulopublico: null,
                titulo: null,
                fecha_inicio: null,
                fecha_fin: null,
                grupo: null,
            },
            noset: ["id"],
        }),
        $parent: $parent,
        
        onSet: function(param, r) {

            // main-list
            IMP.renderListRow(this.$list, 
                IMP.merge(r, {
                    
                    activo: r.IMPactive ? "active" : "",
                    show: r.IMPfilter === false ? "none" : "block",
                    opacity: r.estado != 1 ? "0.6" : "1",
                    fecha_inicio: format_date("short", r.fecha_inicio),
                    fecha_fin: format_date("short", r.fecha_fin),
                    status: moment().isAfter(r.fecha_fin) ? "vencido" :  (moment().isBefore(r.fecha_inicio) ? "programado" : "visible")
                })
                , this.$template, param.row[param.component.pk])
            
            // si esta haciendo filtro omito re-render otras listas
            if(param.value.IMPfilter) return;

            // formulario
            if(r.id == banner_sup.ds.currentPK) {
                
                IMP.set_form(this.$form,
                    IMP.merge(r, {
                        fecha_inicio: format_date("compact", r.fecha_inicio),
                        fecha_fin: format_date("compact", r.fecha_fin),
                    })
                )

                setTags(this.$parent.find("[data-key]"), noErrorParse(r.data))
            }
            
        },

        cb: function(type, p) {

            switch(type) {

                case "get":
                    new Sortable($("#lista1 tbody")[0], {
                        placeholder: true,
                        group: 'shared',
                        animation: 50,
                        ghostClass: 'blue-background-class'
                    });
                    break;

                case "reset": 
                    setTags(this.$parent.find("[data-key]"), {})
                    break;
                    
                case "save":
                    let $target = p.$parent.find("[data-field='data']"),
                        val = getTags(p.$parent.find("[data-key]"), noErrorParse($target.val()))
                    ;
                    $target.val(JSON.stringify(val))
                    break;   
            }
        }
    })
    
    function get_items() {
        banner_sup.get("", {filter:{grupo: banner_sup.$parent.find("[data-select='grupo']")[0].value, estado: banner_sup.$parent.find("[data-select='estado']")[0].value}})
    }
    get_items()
    $parent.find("[data-select='grupo'], [data-select='estado']").on("change", e => get_items())
    

    ds_banners = new DATASET({
        api_model: "banners2",
        scheme: {
            id: null,
            estado: 1, 
            data: null,
            imagen: null,
            imagen2: null,
            imagen3: null,
            position: null,
            titulo: null,
            titulopublico: null,
            fecha_inicio: null,
            fecha_fin: null,
            grupo: null,
        },
        sort: {id: "DESC"},
    })

    submitEvents()

    // Banners
    

    async function loadBanners() {
        banners_obj = {}
        data_banners = await ds_banners.get({filter:{estado: 1}, paging: {limit: 100}})
        data_banners = data_banners.default
        IMP.forEach(data_banners, item => {
            //console.log(">", item.id)
            item.status = moment().isAfter(item.fecha_fin) ? "vencido" : (moment().isBefore(item.fecha_inicio) ? "programado" : "visible")
            banners_obj[item.id] = {item, position: noErrorParse(item.position)}
        })
    }

    function renderBanners() {
        let s = "", data, currentBanners = []

        IMP.forEach(data_banners, item => {
            //console.log("->", item)
            data = banners_obj[item.id].position
            if(data) currentBanners[data[grupo]] = item
        })
        //console.log(currentBanners)
        IMP.forEach(currentBanners, item => {
            s += 
`<tr data-id="${item.id}">
    <td style="width:${grupo == "destacados" ? "100px" : "300px"}"><img src="${item.imagen}" style="width: 100%;" alt="" /></td>
    <td>
        <b>${item.titulo}</b>
        <br><span class="fecha2">${format_date("short", item.fecha_inicio)} - ${format_date("short", item.fecha_fin)}</span>
        <br><span class="status-${item.status}">${item.status}</span>     
    </td>
</tr>`
        })
        $("#lista2 tbody").html(s)
        $("#lbl-grupo").html(grupo)
        new Sortable($("#lista2 tbody")[0], {
            placeholder: true,
            group: 'shared',
            animation: 50,
            ghostClass: 'blue-background-class'
        });
    }

    async function init() {
        await loadBanners()
        renderBanners()
    }
    init()

    $("#btn-posiciones").on("click", "button", async function(e) {
        grupo = e.currentTarget.dataset.id
        renderBanners()
        await loadBanners()
        get_items()
    })

    async function guardarBanners() {
        
        let $elem, sendData = {}, item, data, $target = $("#lista2 tbody"), d, pos;

        position[grupo] = {}

        $target.find("tr").each(function (index){
            position[grupo][this.dataset.id] = index
        })

        
        IMP.forEach(data_banners, (item, index) => {

            data = banners_obj[item.id].position
            //console.log(position, grupo, position[grupo])
            if(position[grupo] == undefined) return
            
            pos = position[grupo][item.id]
            if(pos == undefined) data[grupo] = undefined
            else data[grupo] = pos
            //console.log(data)
            sendData[index] = {
                mode: "set",
                table: "banners2",
                fields: {position: JSON.stringify(data)},
                filter: {id: item.id}
            }
            console.log(sendData[index])
        })
        
        let result = await _fetch(ds_banners.endpoint, sendData)
        
        await loadBanners()
        get_items()
        return true
        
    }

    async function command(action, elem) {
        
        let result, ok

        ListCommand(true, elem)

        switch(action) {
            case "actualizaBanners":
                result = await _fetch("resetcache", {elem: "banners2"})
                ok = result.success
                break;

            case "guardarBanners":
                result = await guardarBanners()
                ok = result.success
                break;

            case "visualizarBanners":
                //result = await visualizarBanners()
                ok = true//result.success
                break;
        }

        ListCommand(false, elem, ok)
    }


    function tabChanged(index) {
        if(index == 1) loadBanners()
    }


</script>